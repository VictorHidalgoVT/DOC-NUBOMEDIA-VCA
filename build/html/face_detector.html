

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Face Detector &mdash; nubomedia-vca 6.1 documentation</title>
  

  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  

  

  
    <link rel="top" title="nubomedia-vca 6.1 documentation" href="index.html"/> 

  
  <script src="_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="index.html" class="icon icon-home"> nubomedia-vca
          

          
            
            <img src="_static/nubomedia_log.png" class="logo" />
          
          </a>

          
            
            
              <div class="version">
                6.1
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
                <ul>
<li class="toctree-l1"><a class="reference internal" href="what_is_nubomedia-vca.html">What&#8217;s Nubomedia-vca?</a></li>
<li class="toctree-l1"><a class="reference internal" href="installation_guide.html">Installation guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="developers_guide.html">Developers guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="APIs.html">Reference documentation of the APIs</a></li>
<li class="toctree-l1"><a class="reference internal" href="architecture.html">Architecture</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="index.html">nubomedia-vca</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          





<div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="index.html">Docs</a> &raquo;</li>
      
    <li>Face Detector</li>
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="_sources/face_detector.txt" rel="nofollow"> View page source</a>
          
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="face-detector">
<span id="id1"></span><h1>Face Detector<a class="headerlink" href="#face-detector" title="Permalink to this headline">¶</a></h1>
<p>This web application  consists on a WebRTC video communication with a face detector filter
(loopback, the media stream going from client to the media server and back to client).</p>
<div class="section" id="compiling-running">
<h2>Compiling &amp; Running<a class="headerlink" href="#compiling-running" title="Permalink to this headline">¶</a></h2>
<p>This section explain how to compile and run the demo in a local environment. To install the
neccesary software please see the <a class="reference internal" href="installation_guide.html"><em>installation guide</em></a>.
To compile you have to options:</p>
<ul class="simple">
<li>To compile everything as it has been explained on the <a class="reference internal" href="installation_guide.html"><em>installation guide</em></a></li>
<li>To compile only this module. Again, here we have two different options</li>
</ul>
<div class="highlight-console"><div class="highlight"><pre><span class="go">cd apps/NuboFaceJava</span>
<span class="go">--First option</span>
<span class="go">sh generate_zip.sh</span>

<span class="go">--Second option</span>
<span class="go">mvn package</span>
</pre></div>
</div>
<p>If we follow the steps explained on the <a class="reference internal" href="installation_guide.html"><em>installation guide</em></a>
, once we restart the media server through the command bellow or reboot the computer,
we can test the application accesing the following URL: <strong>localhost:8100</strong></p>
<div class="highlight-console"><div class="highlight"><pre><span class="go">sudo /etc/init.d/kurento-media-server restart</span>
</pre></div>
</div>
<p>For the second option, we can run the aplication through the following  command.
At this time, the url for accesing the application is: <strong>localhost:8080</strong></p>
<div class="highlight-console"><div class="highlight"><pre><span class="go">java -jar target/NuboFaceJava*.jar</span>
</pre></div>
</div>
</div>
<div class="section" id="understanding-this-example">
<h2>Understanding this example<a class="headerlink" href="#understanding-this-example" title="Permalink to this headline">¶</a></h2>
<p>The following figure shows a screenshoot of this demo running.</p>
<a class="reference internal image-reference" href="_images/face_detector.png"><img alt="face detector application" class="align-center" src="_images/face_detector.png" style="width: 640px;" /></a>
<p>The interface of the application (an HTML web page) is composed by two HTML5 video tags:
one showing the local stream (as captured by the device webcam) and the other showing
the remote stream sent by the media server back to the client. The video camera stream
is sent to Kurento Media Server, which processes and sends it back to the client as a
remote stream. To implement this, we need to create a Media Pipeline composed by the
following Media Elements:</p>
<a class="reference internal image-reference" href="_images/face_pipeline.png"><img alt="face detector pipeline" class="align-center" src="_images/face_pipeline.png" style="width: 480px;" /></a>
<p>This is a web application, and therefore it follows a client-server architecture.
At the client-side, the logic is implemented in JavaScript. At the server-side we use
a Java EE application server consuming a  Client API to control the  Media Server capabilities.
To communicate these entities, two WebSockets are used. First, a WebSocket is created
between client and application server to implement a custom signaling protocol. Second,
another WebSocket is used to perform the communication between the Java Client and the
Media Server. To communicate the client with the Java EE application server the platform uses
a simple signaling protocol based on JSON messages over WebSocket‘s. SDP and ICE candidates needs
to be exchanged between client and server to establish the WebRtc session. If you are interested
on knowing more about the messages exchanged between them, have a look to this
<a class="reference external" href="http://www.kurento.org/docs/current/tutorials/java/tutorial-2-magicmirror.html">example</a> .</p>
</div>
<div class="section" id="application-server-side">
<h2>Application Server Side<a class="headerlink" href="#application-server-side" title="Permalink to this headline">¶</a></h2>
<p>This demo has been developed using a Java EE application server based on the Spring Boot
framework. This technology can be used to embed the Tomcat web server in the application
and thus simplify the development process.</p>
<p>In the following figure you can see a class diagram of the server side code:</p>
<a class="reference internal image-reference" href="_images/FaceJavaClass.png"><img alt="face detector class diagram" class="align-center" src="_images/FaceJavaClass.png" style="width: 480px;" /></a>
<p>The main class of this demo is named NuboFaceJavaApp. As you can see, the NuboMediaClient
is instantiated in this class as a Spring Bean. This bean is used to create  Media Pipelines,
which are used to add media capabilities to your applications. In this instantiation we see
that we need to specify to the client library the location of the Kurento Media Server.
In this example, we assume it’s located at localhost listening in port 8888. If you reproduce
this tutorial you’ll need to insert the specific location of your Kurento Media Server instance
there.</p>
<div class="highlight-java"><div class="highlight"><pre><span class="nd">@Configuration</span>
<span class="nd">@EnableWebSocket</span>
<span class="nd">@EnableAutoConfiguration</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">NuboFaceJavaApp</span> <span class="kd">implements</span> <span class="n">WebSocketConfigurer</span> <span class="o">{</span>

       <span class="kd">final</span> <span class="kd">static</span> <span class="n">String</span> <span class="n">DEFAULT_KMS_WS_URI</span> <span class="o">=</span> <span class="s">&quot;ws://localhost:8888/kurento&quot;</span><span class="o">;</span>

       <span class="nd">@Bean</span>
       <span class="kd">public</span> <span class="n">NuboFaceJavaHandler</span> <span class="nf">handler</span><span class="o">()</span> <span class="o">{</span>
               <span class="k">return</span> <span class="k">new</span> <span class="n">NuboFaceJavaHandler</span><span class="o">();</span>
       <span class="o">}</span>

       <span class="nd">@Bean</span>
       <span class="kd">public</span> <span class="n">KurentoClient</span> <span class="nf">kurentoClient</span><span class="o">()</span> <span class="o">{</span>
               <span class="k">return</span> <span class="n">KurentoClient</span><span class="o">.</span><span class="na">create</span><span class="o">(</span><span class="n">System</span><span class="o">.</span><span class="na">getProperty</span><span class="o">(</span><span class="s">&quot;kms.ws.uri&quot;</span><span class="o">,</span>
                               <span class="n">DEFAULT_KMS_WS_URI</span><span class="o">));</span>
       <span class="o">}</span>

       <span class="nd">@Override</span>
       <span class="kd">public</span> <span class="kt">void</span> <span class="nf">registerWebSocketHandlers</span><span class="o">(</span><span class="n">WebSocketHandlerRegistry</span> <span class="n">registry</span><span class="o">)</span> <span class="o">{</span>
               <span class="n">registry</span><span class="o">.</span><span class="na">addHandler</span><span class="o">(</span><span class="n">handler</span><span class="o">(),</span> <span class="s">&quot;/nubofacedetector&quot;</span><span class="o">);</span>
       <span class="o">}</span>

       <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
               <span class="k">new</span> <span class="n">SpringApplication</span><span class="o">(</span><span class="n">NuboFaceJavaApp</span><span class="o">.</span><span class="na">class</span><span class="o">).</span><span class="na">run</span><span class="o">(</span><span class="n">args</span><span class="o">);</span>
       <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<p>This web application follows Single Page Application architecture and uses a WebSocket
to communicate client with application server by means of requests and responses.
Specifically, the main app class implements the interface WebSocketConfigurer to register
a WebSocketHanlder to process WebSocket requests in the path /nubofacedetector.</p>
<p>NuboFaceJavaHandler class implements TextWebSocketHandler to handle text WebSocket requests.
The central piece of this class is the method handleTextMessage. This method implements
the actions for requests, returning responses through the WebSocket. In other words,
it implements the server part of the signaling protocol depicted.</p>
<p>In the designed protocol there are three different kinds of incoming messages to the Server:
start, show_faces, scale_factor, process_num_frames, width_to_process,  stop and onIceCandidates.
These messages are treated in the switch clause, taking the proper steps in each case.</p>
<div class="highlight-java"><div class="highlight"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">NuboFaceJavaHandler</span> <span class="kd">extends</span> <span class="n">TextWebSocketHandler</span> <span class="o">{</span>

   <span class="nd">@Override</span>
   <span class="kd">public</span> <span class="kt">void</span> <span class="nf">handleTextMessage</span><span class="o">(</span><span class="n">WebSocketSession</span> <span class="n">session</span><span class="o">,</span> <span class="n">TextMessage</span> <span class="n">message</span><span class="o">)</span>
       <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
       <span class="n">JsonObject</span> <span class="n">jsonMessage</span> <span class="o">=</span> <span class="n">gson</span><span class="o">.</span><span class="na">fromJson</span><span class="o">(</span><span class="n">message</span><span class="o">.</span><span class="na">getPayload</span><span class="o">(),</span>
                                              <span class="n">JsonObject</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>

       <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&quot;Incoming message: {}&quot;</span><span class="o">,</span> <span class="n">jsonMessage</span><span class="o">);</span>

       <span class="k">switch</span> <span class="o">(</span><span class="n">jsonMessage</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">&quot;id&quot;</span><span class="o">).</span><span class="na">getAsString</span><span class="o">())</span> <span class="o">{</span>
       <span class="k">case</span> <span class="s">&quot;start&quot;</span><span class="o">:</span>
           <span class="n">start</span><span class="o">(</span><span class="n">session</span><span class="o">,</span> <span class="n">jsonMessage</span><span class="o">);</span>
           <span class="k">break</span><span class="o">;</span>
       <span class="k">case</span> <span class="s">&quot;show_faces&quot;</span><span class="o">:</span>
           <span class="n">setVisualization</span><span class="o">(</span><span class="n">session</span><span class="o">,</span><span class="n">jsonMessage</span><span class="o">);</span>
           <span class="k">break</span><span class="o">;</span>
       <span class="k">case</span> <span class="s">&quot;scale_factor&quot;</span><span class="o">:</span>
           <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&quot;Case scale factor&quot;</span><span class="o">);</span>
           <span class="n">setScaleFactor</span><span class="o">(</span><span class="n">session</span><span class="o">,</span><span class="n">jsonMessage</span><span class="o">);</span>
           <span class="k">break</span><span class="o">;</span>
       <span class="k">case</span> <span class="s">&quot;process_num_frames&quot;</span><span class="o">:</span>
           <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&quot;Case process num frames&quot;</span><span class="o">);</span>
           <span class="n">setProcessNumberFrames</span><span class="o">(</span><span class="n">session</span><span class="o">,</span><span class="n">jsonMessage</span><span class="o">);</span>
           <span class="k">break</span><span class="o">;</span>
       <span class="k">case</span> <span class="s">&quot;width_to_process&quot;</span><span class="o">:</span>
           <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&quot;Case width to process&quot;</span><span class="o">);</span>
           <span class="n">setWidthToProcess</span><span class="o">(</span><span class="n">session</span><span class="o">,</span><span class="n">jsonMessage</span><span class="o">);</span>
           <span class="k">break</span><span class="o">;</span>


       <span class="k">case</span> <span class="s">&quot;stop&quot;</span><span class="o">:</span> <span class="o">{</span>
           <span class="n">UserSession</span> <span class="n">user</span> <span class="o">=</span> <span class="n">users</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="n">session</span><span class="o">.</span><span class="na">getId</span><span class="o">());</span>
           <span class="k">if</span> <span class="o">(</span><span class="n">user</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
               <span class="n">user</span><span class="o">.</span><span class="na">release</span><span class="o">();</span>
           <span class="o">}</span>
           <span class="k">break</span><span class="o">;</span>
       <span class="o">}</span>
       <span class="k">case</span> <span class="s">&quot;onIceCandidate&quot;</span><span class="o">:</span> <span class="o">{</span>
           <span class="n">JsonObject</span> <span class="n">candidate</span> <span class="o">=</span> <span class="n">jsonMessage</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">&quot;candidate&quot;</span><span class="o">)</span>
               <span class="o">.</span><span class="na">getAsJsonObject</span><span class="o">();</span>

           <span class="n">UserSession</span> <span class="n">user</span> <span class="o">=</span> <span class="n">users</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">session</span><span class="o">.</span><span class="na">getId</span><span class="o">());</span>
           <span class="k">if</span> <span class="o">(</span><span class="n">user</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
               <span class="n">IceCandidate</span> <span class="n">cand</span> <span class="o">=</span> <span class="k">new</span> <span class="n">IceCandidate</span><span class="o">(</span><span class="n">candidate</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">&quot;candidate&quot;</span><span class="o">)</span>
                                                    <span class="o">.</span><span class="na">getAsString</span><span class="o">(),</span> <span class="n">candidate</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">&quot;sdpMid&quot;</span><span class="o">).</span><span class="na">getAsString</span><span class="o">(),</span>
                                                    <span class="n">candidate</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">&quot;sdpMLineIndex&quot;</span><span class="o">).</span><span class="na">getAsInt</span><span class="o">());</span>
               <span class="n">user</span><span class="o">.</span><span class="na">addCandidate</span><span class="o">(</span><span class="n">cand</span><span class="o">);</span>
           <span class="o">}</span>
           <span class="k">break</span><span class="o">;</span>
       <span class="o">}</span>

<span class="nl">       default:</span>
           <span class="n">sendError</span><span class="o">(</span><span class="n">session</span><span class="o">,</span>
                     <span class="s">&quot;Invalid message with id &quot;</span>
                     <span class="o">+</span> <span class="n">jsonMessage</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">&quot;id&quot;</span><span class="o">).</span><span class="na">getAsString</span><span class="o">());</span>
           <span class="k">break</span><span class="o">;</span>
       <span class="o">}</span>
   <span class="o">}</span>

   <span class="kd">private</span> <span class="kt">void</span> <span class="nf">start</span><span class="o">(</span><span class="n">WebSocketSession</span> <span class="n">session</span><span class="o">,</span> <span class="n">JsonObject</span> <span class="n">jsonMessage</span><span class="o">)</span> <span class="o">{</span>
     <span class="o">...</span>
  <span class="o">}</span>

<span class="kd">private</span> <span class="kt">void</span> <span class="nf">sendError</span><span class="o">(</span><span class="n">WebSocketSession</span> <span class="n">session</span><span class="o">,</span> <span class="n">String</span> <span class="n">message</span><span class="o">)</span> <span class="o">{</span>
     <span class="o">...</span>
  <span class="o">}</span>
  <span class="o">...</span>
<span class="o">}</span>
</pre></div>
</div>
<p>In the following snippet, we can see the start method. It handles the ICE candidates gathering,
creates a Media Pipeline, creates the Media Elements (WebRtcEndpoint and NuboFaceDetectorFilter)
and make the connections among them. A startResponse message is sent back to the client
with the SDP answer.</p>
<div class="highlight-java"><div class="highlight"><pre><span class="kd">private</span> <span class="kt">void</span> <span class="nf">start</span><span class="o">(</span><span class="kd">final</span> <span class="n">WebSocketSession</span> <span class="n">session</span><span class="o">,</span> <span class="n">JsonObject</span> <span class="n">jsonMessage</span><span class="o">)</span> <span class="o">{</span>
 <span class="k">try</span> <span class="o">{</span>
           <span class="c1">// Media Logic (Media Pipeline and Elements)</span>
           <span class="n">UserSession</span> <span class="n">user</span> <span class="o">=</span> <span class="k">new</span> <span class="n">UserSession</span><span class="o">();</span>
           <span class="n">MediaPipeline</span> <span class="n">pipeline</span> <span class="o">=</span> <span class="n">kurento</span><span class="o">.</span><span class="na">createMediaPipeline</span><span class="o">();</span>
           <span class="n">user</span><span class="o">.</span><span class="na">setMediaPipeline</span><span class="o">(</span><span class="n">pipeline</span><span class="o">);</span>
           <span class="n">webRtcEndpoint</span> <span class="o">=</span> <span class="k">new</span> <span class="n">WebRtcEndpoint</span><span class="o">.</span><span class="na">Builder</span><span class="o">(</span><span class="n">pipeline</span><span class="o">).</span><span class="na">build</span><span class="o">();</span>
           <span class="n">user</span><span class="o">.</span><span class="na">setWebRtcEndpoint</span><span class="o">(</span><span class="n">webRtcEndpoint</span><span class="o">);</span>
           <span class="n">users</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">session</span><span class="o">.</span><span class="na">getId</span><span class="o">(),</span> <span class="n">user</span><span class="o">);</span>

           <span class="n">webRtcEndpoint</span>
               <span class="o">.</span><span class="na">addOnIceCandidateListener</span><span class="o">(</span><span class="k">new</span> <span class="n">EventListener</span><span class="o">&lt;</span><span class="n">OnIceCandidateEvent</span><span class="o">&gt;()</span> <span class="o">{</span>

                       <span class="nd">@Override</span>
                           <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onEvent</span><span class="o">(</span><span class="n">OnIceCandidateEvent</span> <span class="n">event</span><span class="o">)</span> <span class="o">{</span>
                           <span class="n">JsonObject</span> <span class="n">response</span> <span class="o">=</span> <span class="k">new</span> <span class="n">JsonObject</span><span class="o">();</span>
                           <span class="n">response</span><span class="o">.</span><span class="na">addProperty</span><span class="o">(</span><span class="s">&quot;id&quot;</span><span class="o">,</span> <span class="s">&quot;iceCandidate&quot;</span><span class="o">);</span>
                           <span class="n">response</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">&quot;candidate&quot;</span><span class="o">,</span> <span class="n">JsonUtils</span>
                                        <span class="o">.</span><span class="na">toJsonObject</span><span class="o">(</span><span class="n">event</span><span class="o">.</span><span class="na">getCandidate</span><span class="o">()));</span>
                           <span class="k">try</span> <span class="o">{</span>
                               <span class="kd">synchronized</span> <span class="o">(</span><span class="n">session</span><span class="o">)</span> <span class="o">{</span>
                                   <span class="n">session</span><span class="o">.</span><span class="na">sendMessage</span><span class="o">(</span><span class="k">new</span> <span class="n">TextMessage</span><span class="o">(</span>
                                                                       <span class="n">response</span><span class="o">.</span><span class="na">toString</span><span class="o">()));</span>
                               <span class="o">}</span>
                           <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                               <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="n">e</span><span class="o">.</span><span class="na">getMessage</span><span class="o">());</span>
                           <span class="o">}</span>
                       <span class="o">}</span>
                   <span class="o">});</span>

           <span class="n">face</span> <span class="o">=</span> <span class="k">new</span> <span class="n">NuboFaceDetector</span><span class="o">.</span><span class="na">Builder</span><span class="o">(</span><span class="n">pipeline</span><span class="o">).</span><span class="na">build</span><span class="o">();</span>
           <span class="n">webRtcEndpoint</span><span class="o">.</span><span class="na">connect</span><span class="o">(</span><span class="n">face</span><span class="o">);</span>
           <span class="n">face</span><span class="o">.</span><span class="na">connect</span><span class="o">(</span><span class="n">webRtcEndpoint</span><span class="o">);</span>

           <span class="c1">// SDP negotiation (offer and answer)</span>
           <span class="n">String</span> <span class="n">sdpOffer</span> <span class="o">=</span> <span class="n">jsonMessage</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">&quot;sdpOffer&quot;</span><span class="o">).</span><span class="na">getAsString</span><span class="o">();</span>
           <span class="n">String</span> <span class="n">sdpAnswer</span> <span class="o">=</span> <span class="n">webRtcEndpoint</span><span class="o">.</span><span class="na">processOffer</span><span class="o">(</span><span class="n">sdpOffer</span><span class="o">);</span>

           <span class="c1">// Sending response back to client</span>
           <span class="n">JsonObject</span> <span class="n">response</span> <span class="o">=</span> <span class="k">new</span> <span class="n">JsonObject</span><span class="o">();</span>
           <span class="n">response</span><span class="o">.</span><span class="na">addProperty</span><span class="o">(</span><span class="s">&quot;id&quot;</span><span class="o">,</span> <span class="s">&quot;startResponse&quot;</span><span class="o">);</span>
           <span class="n">response</span><span class="o">.</span><span class="na">addProperty</span><span class="o">(</span><span class="s">&quot;sdpAnswer&quot;</span><span class="o">,</span> <span class="n">sdpAnswer</span><span class="o">);</span>

           <span class="kd">synchronized</span> <span class="o">(</span><span class="n">session</span><span class="o">)</span> <span class="o">{</span>
               <span class="n">session</span><span class="o">.</span><span class="na">sendMessage</span><span class="o">(</span><span class="k">new</span> <span class="n">TextMessage</span><span class="o">(</span><span class="n">response</span><span class="o">.</span><span class="na">toString</span><span class="o">()));</span>
           <span class="o">}</span>
           <span class="n">webRtcEndpoint</span><span class="o">.</span><span class="na">gatherCandidates</span><span class="o">();</span>

       <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Throwable</span> <span class="n">t</span><span class="o">)</span> <span class="o">{</span>
           <span class="n">sendError</span><span class="o">(</span><span class="n">session</span><span class="o">,</span> <span class="n">t</span><span class="o">.</span><span class="na">getMessage</span><span class="o">());</span>
       <span class="o">}</span>
   <span class="o">}</span>
</pre></div>
</div>
<p>The sendError method is quite simple: it sends an error message to the client when
an exception is caught in the server-side.</p>
<div class="highlight-java"><div class="highlight"><pre><span class="kd">private</span> <span class="kt">void</span> <span class="nf">sendError</span><span class="o">(</span><span class="n">WebSocketSession</span> <span class="n">session</span><span class="o">,</span> <span class="n">String</span> <span class="n">message</span><span class="o">)</span> <span class="o">{</span>
  <span class="k">try</span> <span class="o">{</span>
     <span class="n">JsonObject</span> <span class="n">response</span> <span class="o">=</span> <span class="k">new</span> <span class="n">JsonObject</span><span class="o">();</span>
     <span class="n">response</span><span class="o">.</span><span class="na">addProperty</span><span class="o">(</span><span class="s">&quot;id&quot;</span><span class="o">,</span> <span class="s">&quot;error&quot;</span><span class="o">);</span>
     <span class="n">response</span><span class="o">.</span><span class="na">addProperty</span><span class="o">(</span><span class="s">&quot;message&quot;</span><span class="o">,</span> <span class="n">message</span><span class="o">);</span>
     <span class="n">session</span><span class="o">.</span><span class="na">sendMessage</span><span class="o">(</span><span class="k">new</span> <span class="n">TextMessage</span><span class="o">(</span><span class="n">response</span><span class="o">.</span><span class="na">toString</span><span class="o">()));</span>
  <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
     <span class="n">log</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">&quot;Exception sending message&quot;</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
</div>
<div class="section" id="application-client-side">
<h2>Application Client Side<a class="headerlink" href="#application-client-side" title="Permalink to this headline">¶</a></h2>
<p>Let’s move now to the client-side of the application. To call the previously created WebSocket
service in the server-side, we use the JavaScript class WebSocket. We use an specific
JavaScript library called kurento-utils.js to simplify the WebRTC interaction with the server.
This library depends on adapter.js, which is a JavaScript WebRTC utility maintained by Google
that abstracts away browser differences. Finally jquery.js is also needed in this application.</p>
<p>These libraries are linked in the index.html web page, and are used in the index.js.
In the following snippet we can see the creation of the WebSocket (variable ws) in the path
/nubofacedetector. Then, the onmessage listener of the WebSocket is used to implement the
JSON signaling protocol in the client-side. Notice that there are three incoming messages
to client: startResponse, error, and iceCandidate. Convenient actions are taken to implement
each step in the communication. For example, in functions start the function
WebRtcPeer.WebRtcPeerSendrecv of kurento-utils.js is used to start a WebRTC communication.</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="kd">var</span> <span class="nx">ws</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">WebSocket</span><span class="p">(</span><span class="s1">&#39;ws://&#39;</span> <span class="o">+</span> <span class="nx">location</span><span class="p">.</span><span class="nx">host</span> <span class="o">+</span> <span class="s1">&#39;/nubofacedetector&#39;</span><span class="p">);</span>

<span class="nx">ws</span><span class="p">.</span><span class="nx">onmessage</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">message</span><span class="p">)</span> <span class="p">{</span>
       <span class="kd">var</span> <span class="nx">parsedMessage</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">message</span><span class="p">.</span><span class="nx">data</span><span class="p">);</span>
       <span class="nx">console</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="s1">&#39;Received message: &#39;</span> <span class="o">+</span> <span class="nx">message</span><span class="p">.</span><span class="nx">data</span><span class="p">);</span>

       <span class="k">switch</span> <span class="p">(</span><span class="nx">parsedMessage</span><span class="p">.</span><span class="nx">id</span><span class="p">)</span> <span class="p">{</span>
       <span class="k">case</span> <span class="s1">&#39;startResponse&#39;</span><span class="o">:</span>
               <span class="nx">startResponse</span><span class="p">(</span><span class="nx">parsedMessage</span><span class="p">);</span>
               <span class="k">break</span><span class="p">;</span>

       <span class="k">case</span> <span class="s1">&#39;iceCandidate&#39;</span><span class="o">:</span>
           <span class="nx">webRtcPeer</span><span class="p">.</span><span class="nx">addIceCandidate</span><span class="p">(</span><span class="nx">parsedMessage</span><span class="p">.</span><span class="nx">candidate</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
       <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">error</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
             <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s2">&quot;Error adding candidate: &quot;</span> <span class="o">+</span> <span class="nx">error</span><span class="p">);</span>
           <span class="p">});</span>
           <span class="k">break</span><span class="p">;</span>

       <span class="k">case</span> <span class="s1">&#39;error&#39;</span><span class="o">:</span>
               <span class="k">if</span> <span class="p">(</span><span class="nx">state</span> <span class="o">==</span> <span class="nx">I_AM_STARTING</span><span class="p">)</span> <span class="p">{</span>
                       <span class="nx">setState</span><span class="p">(</span><span class="nx">I_CAN_START</span><span class="p">);</span>
               <span class="p">}</span>
               <span class="nx">onError</span><span class="p">(</span><span class="s2">&quot;Error message from server: &quot;</span> <span class="o">+</span> <span class="nx">parsedMessage</span><span class="p">.</span><span class="nx">message</span><span class="p">);</span>
               <span class="k">break</span><span class="p">;</span>
       <span class="k">default</span><span class="o">:</span>
               <span class="k">if</span> <span class="p">(</span><span class="nx">state</span> <span class="o">==</span> <span class="nx">I_AM_STARTING</span><span class="p">)</span> <span class="p">{</span>
                       <span class="nx">setState</span><span class="p">(</span><span class="nx">I_CAN_START</span><span class="p">);</span>
               <span class="p">}</span>
               <span class="nx">onError</span><span class="p">(</span><span class="s1">&#39;Unrecognized message&#39;</span><span class="p">,</span> <span class="nx">parsedMessage</span><span class="p">);</span>
       <span class="p">}</span>
<span class="p">}</span>


<span class="kd">function</span> <span class="nx">start</span><span class="p">()</span> <span class="p">{</span>
       <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;Starting video call ...&quot;</span><span class="p">)</span>
       <span class="c1">// Disable start button</span>
       <span class="nx">setState</span><span class="p">(</span><span class="nx">I_AM_STARTING</span><span class="p">);</span>
       <span class="nx">showSpinner</span><span class="p">(</span><span class="nx">videoInput</span><span class="p">,</span> <span class="nx">videoOutput</span><span class="p">);</span>

       <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;Creating WebRtcPeer and generating local sdp offer ...&quot;</span><span class="p">);</span>
       <span class="kd">var</span> <span class="nx">options</span> <span class="o">=</span> <span class="p">{</span>
           <span class="nx">localVideo</span><span class="o">:</span> <span class="nx">videoInput</span><span class="p">,</span>
           <span class="nx">remoteVideo</span><span class="o">:</span> <span class="nx">videoOutput</span><span class="p">,</span>
           <span class="nx">onicecandidate</span><span class="o">:</span> <span class="nx">onIceCandidate</span>
       <span class="p">}</span>

   <span class="nx">webRtcPeer</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">kurentoUtils</span><span class="p">.</span><span class="nx">WebRtcPeer</span><span class="p">.</span><span class="nx">WebRtcPeerSendrecv</span><span class="p">(</span><span class="nx">options</span><span class="p">,</span>
                                                               <span class="kd">function</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
                                                                   <span class="k">if</span><span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
                                                                       <span class="k">return</span> <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="nx">error</span><span class="p">);</span>
                                                                   <span class="p">}</span>
                                                                   <span class="nx">webRtcPeer</span><span class="p">.</span><span class="nx">generateOffer</span> <span class="p">(</span><span class="nx">onOffer</span><span class="p">);</span>
                                                               <span class="p">});</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">onOffer</span><span class="p">(</span><span class="nx">error</span><span class="p">,</span><span class="nx">offerSdp</span><span class="p">)</span> <span class="p">{</span>
       <span class="k">if</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="k">return</span> <span class="nx">console</span><span class="p">.</span><span class="nx">error</span> <span class="p">(</span><span class="s2">&quot;Error generating the offer&quot;</span><span class="p">);</span>
       <span class="nx">console</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="s1">&#39;Invoking SDP offer callback function &#39;</span> <span class="o">+</span> <span class="nx">location</span><span class="p">.</span><span class="nx">host</span><span class="p">);</span>
       <span class="kd">var</span> <span class="nx">message</span> <span class="o">=</span> <span class="p">{</span>
               <span class="nx">id</span> <span class="o">:</span> <span class="s1">&#39;start&#39;</span><span class="p">,</span>
               <span class="nx">sdpOffer</span> <span class="o">:</span> <span class="nx">offerSdp</span>
       <span class="p">}</span>
       <span class="nx">sendMessage</span><span class="p">(</span><span class="nx">message</span><span class="p">);</span>
<span class="p">}</span>


<span class="kd">function</span> <span class="nx">onIceCandidate</span><span class="p">(</span><span class="nx">candidate</span><span class="p">)</span> <span class="p">{</span>
         <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;Local candidate&quot;</span> <span class="o">+</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">candidate</span><span class="p">));</span>

         <span class="kd">var</span> <span class="nx">message</span> <span class="o">=</span> <span class="p">{</span>
           <span class="nx">id</span><span class="o">:</span> <span class="s1">&#39;onIceCandidate&#39;</span><span class="p">,</span>
           <span class="nx">candidate</span><span class="o">:</span> <span class="nx">candidate</span>
         <span class="p">};</span>
         <span class="nx">sendMessage</span><span class="p">(</span><span class="nx">message</span><span class="p">);</span>
 <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="dependencies">
<h2>Dependencies<a class="headerlink" href="#dependencies" title="Permalink to this headline">¶</a></h2>
<p>This Java Spring application is implemented using Maven. The relevant part of the pom.xml
is where NUBOMEDIA dependencies are declared.  we need  two dependencies:
the Client Java dependency (kurento-client) and the JavaScript Kurento
utility library (kurento-utils) for the client-side.</p>
<div class="highlight-xml"><div class="highlight"><pre><span class="nt">&lt;dependencies&gt;</span>
   <span class="nt">&lt;dependency&gt;</span>
      <span class="nt">&lt;groupId&gt;</span>org.kurento<span class="nt">&lt;/groupId&gt;</span>
      <span class="nt">&lt;artifactId&gt;</span>kurento-client<span class="nt">&lt;/artifactId&gt;</span>
      <span class="nt">&lt;version&gt;</span>|CLIENT_JAVA_VERSION|<span class="nt">&lt;/version&gt;</span>
   <span class="nt">&lt;/dependency&gt;</span>
   <span class="nt">&lt;dependency&gt;</span>
      <span class="nt">&lt;groupId&gt;</span>org.kurento<span class="nt">&lt;/groupId&gt;</span>
      <span class="nt">&lt;artifactId&gt;</span>kurento-utils-js<span class="nt">&lt;/artifactId&gt;</span>
      <span class="nt">&lt;version&gt;</span>|CLIENT_JAVA_VERSION|<span class="nt">&lt;/version&gt;</span>
   <span class="nt">&lt;/dependency&gt;</span>
<span class="nt">&lt;/dependencies&gt;</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">We are in active development. You can find the latest version of
Kurento Java Client at <a class="reference external" href="http://search.maven.org/#search%7Cga%7C1%7Ckurento-client">Maven Central</a>.</p>
</div>
<p>Kurento Java Client has a minimum requirement of <strong>Java 7</strong>. To configure the
application to use Java 7, we have to include the following properties in the
properties section:</p>
<div class="highlight-xml"><div class="highlight"><pre><span class="nt">&lt;maven.compiler.target&gt;</span>1.7<span class="nt">&lt;/maven.compiler.target&gt;</span>
<span class="nt">&lt;maven.compiler.source&gt;</span>1.7<span class="nt">&lt;/maven.compiler.source&gt;</span>
</pre></div>
</div>
<p>Browser dependencies (i.e. <em>bootstrap</em>, <em>ekko-lightbox</em>, and <em>adapter.js</em>) are
handled with <span class="xref std std-term">Bower</span>. This dependencies are defined in the file
bower.json  The command <code class="docutils literal"><span class="pre">bower</span> <span class="pre">install</span></code> is automatically called from Maven. Thus, Bower
should be present in your system. It can be installed in an Ubuntu machine as
follows:</p>
<div class="highlight-sh"><div class="highlight"><pre>curl -sL https://deb.nodesource.com/setup <span class="p">|</span> sudo bash -
sudo apt-get install -y nodejs
sudo npm install -g bower
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p><em>kurento-utils-js</em> can be resolved as a Java dependency but also is available on Bower. To use this library from Bower, add this dependency to the file bower.json:</p>
<div class="last highlight-js"><div class="highlight"><pre><span class="s2">&quot;dependencies&quot;</span><span class="o">:</span> <span class="p">{</span>
   <span class="s2">&quot;kurento-utils&quot;</span><span class="o">:</span> <span class="s2">&quot;|UTILS_JS_VERSION|&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</div>
</div>


           </div>
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2015, Victor Hidalgo.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'./',
            VERSION:'6.1',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="_static/jquery.js"></script>
      <script type="text/javascript" src="_static/underscore.js"></script>
      <script type="text/javascript" src="_static/doctools.js"></script>

  

  
  
    <script type="text/javascript" src="_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>